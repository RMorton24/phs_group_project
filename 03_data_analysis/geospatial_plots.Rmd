---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(rgeos)
library(leaflet)
library(sf)
library(tsibble)
library(lubridate)
```



```{r}
beds <- read_csv(here::here("02_cleaned_data/bed_clean.csv")) %>% 
  mutate(year_quarter = yearquarter(year_quarter))
```




```{r}
temp %>%  distinct(HB)
```





```{r}
bbox <- st_bbox(nhs_borders) %>% 
  as.vector()

leaflet(nhs_borders) %>% 
  addPolygons(fillColor = ~pal(HBCode),
              fillOpacity = 1,
              weight = 1, 
              color = "white",
              label = labels,
              labelOptions = labelOptions(),
              highlightOptions = highlightOptions(color = "#666",
                                                  weight = 5,
                                                  bringToFront = TRUE)) %>% 
  setMaxBounds(bbox[1], bbox[2], bbox[3], bbox[4])
```





```{r}
# Load in the region geometry
nhs_borders <- st_read(dsn = "../01_data/geospatial_data/SG_NHS_HealthBoards_2019/", 
                       layer = "SG_NHS_HealthBoards_2019") %>% 
  st_simplify(dTolerance = 2500) %>% 
  st_transform('+proj=longlat +datum=WGS84')

# 
# st_write(nhs_borders,
#          dsn = here::here("02_cleaned_data/nhs_region_simple"),
#          driver = "ESRI Shapefile")
```

```{r}
input <- list(year_quarter = c("2019 Q3", "2019 Q4"),
              speciality_name = "All Specialties",
              variable_to_plot = temp_select[1])

# region_selected <- input$region$id


heatmap_data <- beds %>% 
  filter(year_quarter >= yearquarter(input$year_quarter[1]) &
           year_quarter <= yearquarter(input$year_quarter[2]),
         specialty_name == input$speciality_name) %>% 
  group_by(HBCode = hb) %>% 
  select(!!as.name(input$variable_to_plot)) %>% 
  summarise(plot_this = mean(!!as.name(input$variable_to_plot), na.rm = TRUE))



a_shape <- sp::merge(nhs_borders, heatmap_data, by = c("HBCode" = "HBCode"))

range <- c(min(a_shape$plot_this), max(a_shape$plot_this)) 
           
  #          %>% 
  # summarise(across(.cols = plot_this, 
  #                  .fns = list(min = min, 
  #                              max = max), .names = "{.fn}"))

bins <- seq(from = range[1], to = range[2], by = (range[2] - range[1])/9)

hot_colour <- colorBin(palette = "YlOrRd", domain = a_shape$plot_this, bins = bins)

hot_colour(a_shape$plot_this)

leaflet(a_shape) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~hot_colour(plot_this),
              fillOpacity = 1,
              weight = 1, 
              color = "black",
              dash = 4) %>% 
  addLegend(pal = hot_colour,
            values = ~plot_this, title = input$variable_to_plot,
            position = "bottomright") %>% 
  setMaxBounds(bbox[1], bbox[2], bbox[3], bbox[4])

  
```


```{r}



leaflet(nhs_borders) %>% 
  addPolygons(fillColor = ~pal(HBCode),
              fillOpacity = 1,
              weight = 1, 
              color = "white",
              label = labels,
              labelOptions = labelOptions(),
              highlightOptions = highlightOptions(color = "#666",
                                                  weight = 5,
                                                  bringToFront = TRUE)) %>% 
  setMaxBounds(bbox[1], bbox[2], bbox[3], bbox[4])

```




```{r}
temp_select <- beds %>% 
  select(contains(c("bed", "occup"))) %>%  names()


input <- list(year_quarter = c("2019 Q3", "2019 Q4"),
              speciality_name = "All Specialties",
              variable_to_plot = temp_select[1])

beds %>% 
  filter(year_quarter >= yearquarter(input$year_quarter[1]) &
           year_quarter <= yearquarter(input$year_quarter[2]),
         specialty_name == input$speciality_name) %>% 
  group_by(HBCode = hb) %>% 
  select(!!as.name(input$variable_to_plot)) %>% 
  summarise( case_when(
    str_detect(input$variable_to_plot, "percent") ~ mean(!!as.name(input$variable_to_plot)),
    TRUE ~ sum(!!as.name(input$variable_to_plot))
  )
  )
```

