---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(rgeos)
library(leaflet)
library(sf)
```


```{r}
nhs_borders <- st_read(dsn = "../01_data/geospatial_data/SG_NHS_HealthBoards_2019/", layer = "SG_NHS_HealthBoards_2019")
```

```{r}
proj4string(nhs_borders)
```

```{r}
leaflet(nhs_borders) %>% 
  addPolygons()
```

```{r}
projection <- '+proj=longlat +datum=WGS84'


temp <- spTransform(nhs_borders, projection)
```

```{r}
t2 <- st_cast(nhs_borders$geometry, "POLYGON")
```

```{r}
plot(t2)
```

```{r}
a <- st_transform(nhs_borders, 4326)
```

```{r}
leaflet(a) %>% 
  addTiles()
  addPolygons()
```

```{r}
epsg27700 <- leafletCRS(crsClass = "L.Proj.CRS", code = "EPSG:27700",
                       proj4def = "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",
                       resolutions = c(896.0, 448.0, 224.0, 112.0, 56.0, 28.0, 14.0, 7.0, 3.5, 1.75),#2^(13:-1), # 8192 down to 0.5
                       origin = c(-238375.0, 1376256.0)
)

tile_url <- "https://api.os.uk/maps/raster/v1/zxy/Leisure_27700/{z}/{x}/{y}.png?key=iJIgGUXKYFiT2s2ejG7cAB0sGuvtOCyp"
```


```{r}
leaflet(options = leafletOptions( crs = epsg27700)) %>%
  addTiles()%>%
  
  # WGS84 Markers are transformed to EPSG:27700 behind the scenes
  addMarkers(-0.16359, 51.5083) %>% 
  addPolygons(data = nhs_borders$geometry)
```

```{r}
nhs_borders %>% 
  ggplot() +
  geom_sf()
```


```{r}
simple_nhs <- nhs_borders %>% 
  st_simplify(dTolerance = 2500)
  
  
  
  
  ggplot() +
  geom_sf()
  
  st_write(dsn = "nhs_simple", layer = "nhs_board", driver = "ESRI Shapefile")
```




```{r}
nhs_trans <- simple_nhs %>% 
  st_transform('+proj=longlat +datum=WGS84')


```

```{r}
pal2 <- colorFactor("viridis", domain = nhs_trans$HBCode, n = 14)

labels <- paste0(
  "<b>", nhs_trans$HBName, "</b><br>", nhs_trans$HBCode
) %>% lapply(htmltools::HTML)

leaflet(nhs_trans) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~pal2(HBCode),fillOpacity = 1,
              weight = 1, 
              label = labels,
              labelOptions = labelOptions())
```

```{r}
leaflet(nhs_trans) %>% 
  addPolygons(fillColor = ~pal2(HBCode),fillOpacity = 1,
              weight = 1, 
              color = "white",
              label = labels,
              labelOptions = labelOptions(),
              highlightOptions = highlightOptions(color = "#666",
                                                  weight = 5,
                                                  bringToFront = TRUE)
              ) %>% 
  setMaxBounds(-3, 55.4, -2, 60)
```


```{r}
region_highlight <- 	"S08000020"
nhs_borders[6,1]



leaflet(nhs_borders) %>% 
  addPolygons(fillColor = ~pal2(HBCode),
              fillOpacity = 1,
              weight = 1, 
              color = "white",
              label = labels,
              labelOptions = labelOptions(),
              highlightOptions = highlightOptions(color = "#666",
                                                  weight = 5,
                                                  bringToFront = TRUE)) %>% 
                addPolylines(data = b,
                             layerId = "highlight",
                             weight = 10, 
                             color = "red")
```

```{r}
bbox <- st_bbox(nhs_borders) %>% 
  as.vector()

leaflet(nhs_borders) %>% 
  addPolygons(fillColor = ~pal(HBCode),
              fillOpacity = 1,
              weight = 1, 
              color = "white",
              label = labels,
              labelOptions = labelOptions(),
              highlightOptions = highlightOptions(color = "#666",
                                                  weight = 5,
                                                  bringToFront = TRUE)) %>% 
  setMaxBounds(bbox[1], bbox[2], bbox[3], bbox[4])
```

